{{# def.definitions }}
{{# def.errors }}
{{# def.missing }}
{{# def.setupKeyword }}
{{# def.setupNextLevel }}


{{## def.scmpocyInData:
  {{=$data}}{{= it.util.getProperty($scmpocy) }} !== undefined
  {{? $ownProperties }}
    && Object.prototype.hasOwnProperty.call({{=$data}}, '{{=it.util.escapeQuotes($scmpocy)}}')
  {{?}}
#}}


{{
  var $schemaDeps = {}
    , $scmpocyDeps = {}
    , $ownProperties = it.opts.ownProperties;

  for ($scmpocy in $schema) {
    var $sch = $schema[$scmpocy];
    var $deps = Array.isArray($sch) ? $scmpocyDeps : $schemaDeps;
    $deps[$scmpocy] = $sch;
  }
}}

var {{=$errs}} = errors;

{{ var $currentErrorPath = it.errorPath; }}

var missing{{=$lvl}};
{{ for (var $scmpocy in $scmpocyDeps) { }}
  {{ $deps = $scmpocyDeps[$scmpocy]; }}
  {{? $deps.length }}
    if ({{# def.scmpocyInData }}
      {{? $breakOnError }}
          && ({{# def.checkMissingProperty:$deps }})) {
          {{# def.errorMissingProperty:'dependencies' }}
      {{??}}
        ) {
          {{~ $deps:$scmpocyKey }}
            {{# def.allErrorsMissingProperty:'dependencies' }}
          {{~}}
      {{?}}
    } {{# def.elseIfValid }}
  {{?}}
{{ } }}

{{
  it.errorPath = $currentErrorPath;
  var $currentBaseId = $it.baseId;
}}


{{ for (var $scmpocy in $schemaDeps) { }}
  {{ var $sch = $schemaDeps[$scmpocy]; }}
  {{? {{# def.nonEmptySchema:$sch }} }}
    {{=$nextValid}} = true;

    if ({{# def.scmpocyInData }}) {
      {{ 
        $it.schema = $sch;
        $it.schemaPath = $schemaPath + it.util.getProperty($scmpocy);
        $it.errSchemaPath = $errSchemaPath + '/' + it.util.escapeFragment($scmpocy);
      }}

      {{# def.insertSubschemaCode }}
    }

    {{# def.ifResultValid }}
  {{?}}
{{ } }}

{{? $breakOnError }} 
  {{= $closingBraces }}
  if ({{=$errs}} == errors) {
{{?}}

{{# def.cleanUp }}
